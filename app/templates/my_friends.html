{% extends "base.html" %}

{% block title %}My Friends{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/badge.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='general_styles.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

<div class="container mt-5">
    <h1 class="text-center mb-4 text-heading">Friends of {{ user.username }}</h1>

    <!-- Search Form -->
    <div class="search-bar mb-4 position-relative">
        <form method="GET" action="{{ url_for('views.search_users') }}" class="d-flex">
            <input type="text" id="search-input" name="q" class="form-control me-2" placeholder="Search for a user..." required autocomplete="off">
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
        <div id="suggestions" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
    </div>

    <!-- Recommended Friend -->
    <div class="recommended-friend mt-5">
        <h2>Recommended Friend</h2>
        {% if similar_user %}
        <div class="card text-center">
          <div class="card-body">
            {% if similar_user.profileImage %}
              <img src="{{ url_for('views.uploaded_file', filename=similar_user.profileImage) }}"
                   alt="{{ similar_user.username }}" 
                   class="profileImage"
                   style="width: 100px; height: 100px; object-fit: cover;">
            {% endif %}
                <h5 class="card-title">{{ similar_user.username }}</h5>
                <p class="card-text">This user has similar taste preferences to you!</p>
                <a href="{{ url_for('views.user_profile', user_id=similar_user.id) }}" class="btn btn-primary">View Profile</a>
            </div>
        </div>
        {% else %}
        <p class="text-center text-muted">No similar friends found.</p>
        {% endif %}
    </div>

    <!-- Friends List -->
    <div class="users-to-follow mt-5">
        <h2>All Friends</h2>
        <ul class="list-group">
            {% for user in all_users %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>
                    {{ user.username }}
                    <span class="badge badge-level level-{{ user_levels[user.id] }}">Level {{ user_levels[user.id] }}</span>
                </span>
                <button class="btn {% if user.id in followed_users %}btn-danger{% else %}btn-success{% endif %} follow-button" data-user-id="{{ user.id }}">
                    {% if user.id in followed_users %}Unfollow{% else %}Follow{% endif %}
                </button>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Friend Posts Carousel -->
    <div class="friend-posts-carousel mt-5">
        <h2 class="text-center">üî• Posts from Your Friends</h2>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
            {% for review in notes %}
                {% include "post.html" %}
            {% else %}
            <p class="text-muted text-center mt-5">No posts from your friends yet.</p>
            {% endfor %}
        </div>
    </div>
        
</div>

<style>
    #suggestions {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: white;
    }

    #suggestions a {
        text-decoration: none;
        color: #333;
    }

    #suggestions a:hover {
        background-color: #f0f0f0;
    }

    .trending-dishes .dish-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        margin-bottom: 20px;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 10px;
        background-color: #fff;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .trending-dishes .dish-card:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
    }

    .trending-dishes .dish-card img {
        width: 100%;
        max-width: 300px;
        height: 200px;
        object-fit: cover;
        border-radius: 10px;
        margin-bottom: 10px;
    }

    .trending-dishes .dish-card h5 {
        font-size: 1.2rem;
        margin-bottom: 5px;
    }

    .trending-dishes .dish-card p {
        font-size: 0.9rem;
        color: #555;
    }

    .trending-dishes .dish-card.trending {
        border-color: #DF6F1B;
        background-color: #fff7e6;
        box-shadow: 0 8px 15px rgba(223, 111, 27, 0.5);
    }

    .trending-dishes .dish-card .likes {
        font-weight: bold;
        color: #DF6F1B;
    }

    .staggered-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
    }

    .dish-card, .post-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        margin-bottom: 20px;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 10px;
        background-color: #fff;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .dish-card.trending, .post-card.special {
        border-color: #DF6F1B;
        background-color: #fff7e6;
        box-shadow: 0 8px 15px rgba(223, 111, 27, 0.5);
    }

    .swipeable-container {
        display: flex;
        overflow-x: auto;
        gap: 20px;
        padding: 20px;
        scroll-snap-type: x mandatory;
    }

    .swipeable-container .recommendation-card {
        flex: 0 0 auto;
        width: 300px;
        scroll-snap-align: center;
        border: 2px solid #ddd;
        border-radius: 10px;
        background-color: #fff;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease-in-out;
    }

    .swipeable-container .recommendation-card:hover {
        transform: scale(1.05);
    }

    .carousel {
        display: flex;
        overflow: hidden;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        position: relative;
    }

    .carousel .recommendation-card {
        flex: 0 0 100%;
        transition: transform 0.5s ease-in-out;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 10px;
        background-color: #fff;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .carousel .recommendation-card img {
        width: 100%;
        max-width: 300px;
        height: 200px;
        object-fit: cover;
        border-radius: 10px;
        margin-bottom: 10px;
    }

    .carousel .recommendation-card.special {
        border-color: #DF6F1B;
        background-color: #fff7e6;
        box-shadow: 0 8px 15px rgba(223, 111, 27, 0.5);
    }

    .carousel .recommendation-card.special::after {
        content: "üî• Featured Post";
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #DF6F1B;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.9rem;
        font-weight: bold;
    }

    .carousel-controls {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
    }
</style>

<script>
    // Follow/Unfollow a user and toggle posts visibility
    document.querySelectorAll('.follow-button').forEach(button => {
        button.addEventListener('click', () => {
            const userId = button.getAttribute('data-user-id');
            const isFollowing = button.classList.contains('btn-danger');
            const url = isFollowing ? `/unfollow/${userId}` : `/follow/${userId}`;
            const method = 'POST';

            fetch(url, { method })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Toggle button appearance and text
                        button.classList.toggle('btn-success');
                        button.classList.toggle('btn-danger');
                        button.textContent = isFollowing ? 'Follow' : 'Unfollow';

                        // Show or hide posts for the user
                        document.querySelectorAll(`.user-post[data-user-id="${userId}"]`).forEach(post => {
                            post.style.display = isFollowing ? 'none' : 'block';
                        });
                    } else {
                        console.error(data.error);
                    }
                })
                .catch(error => console.error('Error:', error));
        });
    });

    // Like/Unlike a post and update the likes count dynamically
    document.querySelectorAll('.like-button').forEach(button => {
        button.addEventListener('click', () => {
            const noteId = button.getAttribute('data-note-id');
            fetch(`/like/${noteId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const likeCount = button.querySelector('.action-count');
                        likeCount.textContent = data.likes; // Update the likes count dynamically
                    } else {
                        console.error(data.error);
                    }
                })
                .catch(error => console.error('Error:', error));
        });
    });

    // Search suggestions
    const searchInput = document.getElementById('search-input');
    const suggestionsBox = document.getElementById('suggestions');

    searchInput.addEventListener('input', () => {
        const query = searchInput.value.trim();
        if (query.length === 0) {
            suggestionsBox.innerHTML = '';
            return;
        }

        // Fetch suggestions from the backend
        fetch(`/api/search_suggestions?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate the suggestions box
                    suggestionsBox.innerHTML = data.suggestions.map(username => `
                        <a href="/search_users?q=${encodeURIComponent(username)}" class="list-group-item list-group-item-action">
                            ${username}
                        </a>
                    `).join('');
                }
            })
            .catch(error => console.error('Error:', error));
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', (event) => {
        if (!searchInput.contains(event.target)) {
            suggestionsBox.innerHTML = '';
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const trendingContainer = document.getElementById('trending-dishes-container');

        // Fetch trending dishes from the backend
        fetch('/trending_dishes')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const dishes = data.dishes;

                    // Highlight the most liked dish
                    dishes.forEach((dish, index) => {
                        const dishCard = `
                            <div class="dish-card ${index === 0 ? 'trending' : ''}">
                                <img src="${dish.image || 'https://via.placeholder.com/300'}" alt="${dish.restaurant}">
                                <h5>${dish.restaurant}</h5>
                                <p>${dish.review}</p>
                                <p class="likes">‚ù§Ô∏è ${dish.likes} Likes</p>
                                <p>Spiciness: ${dish.spiciness}, Deliciousness: ${dish.deliciousness}, Value: ${dish.value}, Plating: ${dish.plating}</p>
                            </div>
                        `;
                        trendingContainer.innerHTML += dishCard;
                    });
                } else {
                    trendingContainer.innerHTML = '<p class="text-muted text-center">No trending dishes found.</p>';
                }
            })
            .catch(error => console.error('Error fetching trending dishes:', error));
    });

    document.addEventListener('DOMContentLoaded', () => {
        const postsContainer = document.getElementById('merged-posts-container');
        const recommendationsContainer = document.getElementById('recommendations-container');

        // Fetch merged posts
        fetch('/merged_posts')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const posts = data.posts;

                    // Display merged posts
                    posts.forEach(post => {
                        const postCard = `
                            <div class="post-card ${post.is_special ? 'special' : ''}">
                                <img src="${post.image || 'https://via.placeholder.com/300'}" alt="${post.restaurant}">
                                <h5>${post.restaurant}</h5>
                                <p>${post.review}</p>
                                <p class="likes">‚ù§Ô∏è ${post.likes} Likes</p>
                                <p>Spiciness: ${post.spiciness}, Deliciousness: ${post.deliciousness}, Value: ${post.value}, Plating: ${post.plating}</p>
                                <p><strong>Location:</strong> ${post.location || "Not specified"}</p>
                            </div>
                        `;
                        postsContainer.innerHTML += postCard;
                    });

                    // Display swipeable recommendations (same as posts but in a swipeable format)
                    posts.forEach(post => {
                        const recommendationCard = `
                            <div class="recommendation-card ${post.is_special ? 'special' : ''}">
                                <img src="${post.image || 'https://via.placeholder.com/300'}" alt="${post.restaurant}">
                                <h5>${post.restaurant}</h5>
                                <p>${post.review}</p>
                                <p class="likes">‚ù§Ô∏è ${post.likes} Likes</p>
                                <p>Spiciness: ${post.spiciness}, Deliciousness: ${post.deliciousness}, Value: ${post.value}, Plating: ${post.plating}</p>
                                <p><strong>Location:</strong> ${post.location || "Not specified"}</p>
                            </div>
                        `;
                        recommendationsContainer.innerHTML += recommendationCard;
                    });
                } else {
                    postsContainer.innerHTML = '<p class="text-muted text-center">No posts found.</p>';
                    recommendationsContainer.innerHTML = '<p class="text-muted text-center">No recommendations found.</p>';
                }
            })
            .catch(error => console.error('Error fetching posts:', error));
    });

    document.addEventListener('DOMContentLoaded', () => {
        const carousel = document.getElementById('recommendations-carousel');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        let currentIndex = 0;

        // Fetch posts
        fetch('/merged_posts')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const posts = data.posts;

                    // Populate the carousel
                    posts.forEach(post => {
                        const recommendationCard = `
                            <div class="recommendation-card ${post.is_special ? 'special' : ''}">
                                <img src="${post.image || 'https://via.placeholder.com/300'}" alt="${post.restaurant}">
                                <h5>${post.restaurant}</h5>
                                <p>${post.review}</p>
                                <p class="likes">‚ù§Ô∏è ${post.likes} Likes</p>
                                <p>Spiciness: ${post.spiciness}, Deliciousness: ${post.deliciousness}, Value: ${post.value}, Plating: ${post.plating}</p>
                                <p><strong>Location:</strong> ${post.location || "Not specified"}</p>
                            </div>
                        `;
                        carousel.innerHTML += recommendationCard;
                    });

                    // Set initial position
                    updateCarousel();
                } else {
                    carousel.innerHTML = '<p class="text-muted text-center">No posts found.</p>';
                }
            })
            .catch(error => console.error('Error fetching posts:', error));

        // Update carousel position
        function updateCarousel() {
            const cards = document.querySelectorAll('.recommendation-card');
            cards.forEach((card, index) => {
                card.style.transform = `translateX(${(index - currentIndex) * 100}%)`;
            });
        }

        // Previous button
        prevBtn.addEventListener('click', () => {
            const cards = document.querySelectorAll('.recommendation-card');
            if (currentIndex > 0) {
                currentIndex--;
                updateCarousel();
            }
        });

        // Next button
        nextBtn.addEventListener('click', () => {
            const cards = document.querySelectorAll('.recommendation-card');
            if (currentIndex < cards.length - 1) {
                currentIndex++;
                updateCarousel();
            }
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const carousel = document.getElementById('friend-posts-carousel');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        let currentIndex = 0;

        // Fetch posts from followed friends
        fetch('/friend_posts')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const posts = data.posts;

                    // Populate the carousel
                    posts.forEach(post => {
                        const recommendationCard = `
                            <div class="recommendation-card">
                                <img src="${post.image || 'https://via.placeholder.com/300'}" alt="${post.restaurant}">
                                <h5>${post.restaurant}</h5>
                                <p>${post.review}</p>
                                <p class="likes">‚ù§Ô∏è ${post.likes} Likes</p>
                                <p>Spiciness: ${post.spiciness}, Deliciousness: ${post.deliciousness}, Value: ${post.value}, Plating: ${post.plating}</p>
                                <p><strong>Location:</strong> ${post.location || "Not specified"}</p>
                            </div>
                        `;
                        carousel.innerHTML += recommendationCard;
                    });

                    // Set initial position
                    updateCarousel();
                } else {
                    carousel.innerHTML = '<p class="text-muted text-center">No posts found.</p>';
                }
            })
            .catch(error => console.error('Error fetching posts:', error));

        // Update carousel position
        function updateCarousel() {
            const cards = document.querySelectorAll('.recommendation-card');
            cards.forEach((card, index) => {
                card.style.transform = `translateX(${(index - currentIndex) * 100}%)`;
            });
        }

        // Previous button
        prevBtn.addEventListener('click', () => {
            const cards = document.querySelectorAll('.recommendation-card');
            if (currentIndex > 0) {
                currentIndex--;
                updateCarousel();
            }
        });

        // Next button
        nextBtn.addEventListener('click', () => {
            const cards = document.querySelectorAll('.recommendation-card');
            if (currentIndex < cards.length - 1) {
                currentIndex++;
                updateCarousel();
            }
        });
    });
</script>
{% endblock %}