{% extends "base.html" %}

{% block title %}My Friends{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/general_styles.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/my_friends.css') }}">

<div class="container mt-5">
    <h1 class="text-center mb-4 text-heading">Friends of {{ user.username }}</h1>

    <!-- Search Form -->
    <div class="search-bar mb-4 position-relative">
        <form method="GET" action="{{ url_for('views.search_users') }}" class="d-flex">
            <input type="text" id="search-input" name="q" class="form-control me-2" placeholder="Search for a user..." required autocomplete="off">
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
        <div id="suggestions" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
    </div>

    <!-- Recommended Friend -->
    <div class="recommended-friend mt-5">
        <h2>Recommended Friend</h2>
        {% if similar_user %}
        <div class="card text-center">
            <div class="card-body">
                <img src="{{ url_for('static', filename=similar_user.profile_photo or 'default_profile.jpg') }}" 
                     alt="{{ similar_user.username }}" 
                     class="rounded-circle mb-3" 
                     style="width: 100px; height: 100px; object-fit: cover;">
                <h5 class="card-title">{{ similar_user.username }}</h5>
                <p class="card-text">This user has similar taste preferences to you!</p>
                <a href="{{ url_for('views.user_profile', user_id=similar_user.id) }}" class="btn btn-primary">View Profile</a>
            </div>
        </div>
        {% else %}
        <p class="text-center text-muted">No similar friends found.</p>
        {% endif %}
    </div>

    <!-- Friends List -->
    <div class="users-to-follow mt-5">
        <h2>All Friends</h2>
        <ul class="list-group">
            {% for user in all_users %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>
                    {{ user.username }}
                    <span class="badge badge-level level-{{ user_levels[user.id] }}">Level {{ user_levels[user.id] }}</span>
                </span>
                <button class="btn {% if user.id in followed_users %}btn-danger{% else %}btn-success{% endif %} follow-button" data-user-id="{{ user.id }}">
                    {% if user.id in followed_users %}Unfollow{% else %}Follow{% endif %}
                </button>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Friend Posts Carousel -->
    <div class="friend-posts-carousel mt-5">
        <h2 class="text-center">üî• Posts from Your Friends</h2>
        <div id="friend-posts-carousel" class="carousel">
            <!-- Swipeable posts will be dynamically loaded here -->
        </div>
        <div class="carousel-controls">
            <button id="prev-btn" class="btn btn-secondary">‚¨ÖÔ∏è Previous</button>
            <button id="next-btn" class="btn btn-secondary">‚û°Ô∏è Next</button>
        </div>
    </div>

    <!-- Compare Stats Section -->
    <div class="compare-stats mt-5">
        <h2 class="text-center">Compare Your Stats with a Friend</h2>
        <div class="mb-3 text-center" style="position:relative; max-width:350px; margin:0 auto;">
            <label for="friend-compare-search" class="form-label">Search for a friend to compare:</label>
            <input id="friend-compare-search" class="form-control" type="text" placeholder="Type a friend's name..." autocomplete="off">
            <div id="friend-compare-suggestions" class="list-group position-absolute w-100" style="z-index: 2000;"></div>
        </div>
        <div id="compare-stats-table" style="display:none;">
            <div class="compare-cards d-flex justify-content-center align-items-stretch gap-4 flex-wrap">
                <div class="compare-card me-card">
                    <h4>You</h4>
                    <div class="compare-value"><span>Spiciness</span><span id="my-spiciness">-</span></div>
                    <div class="compare-value"><span>Deliciousness</span><span id="my-deliciousness">-</span></div>
                    <div class="compare-value"><span>Value</span><span id="my-value">-</span></div>
                    <div class="compare-value"><span>Plating</span><span id="my-plating">-</span></div>
                    <div class="compare-value"><span>Posts Reviewed</span><span id="my-posts">-</span></div>
                </div>
                <div class="compare-card friend-card">
                    <h4 id="friend-name-header">Friend</h4>
                    <div class="compare-value"><span>Spiciness</span><span id="friend-spiciness">-</span></div>
                    <div class="compare-value"><span>Deliciousness</span><span id="friend-deliciousness">-</span></div>
                    <div class="compare-value"><span>Value</span><span id="friend-value">-</span></div>
                    <div class="compare-value"><span>Plating</span><span id="friend-plating">-</span></div>
                    <div class="compare-value"><span>Posts Reviewed</span><span id="friend-posts">-</span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const userNotesLength = {{ user_notes | length | default(0) }};
</script>
{% endblock %}