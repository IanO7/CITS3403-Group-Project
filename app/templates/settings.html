{% extends "base.html" %}
{% block title %}Settings{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Settings</h1>

    <!-- ────────────────  Update User Information  ──────────────── -->
    <form id="update-info-form" method="POST" action="/settings">
        <h3>Update Information</h3>
        <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" name="username" value="{{ user.username }}" required>
        </div>
        <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" required>
        </div>
        <button type="submit" class="btn btn-primary" name="action" value="update_info">Update Info</button>
    </form>

    <hr>

    <!-- ────────────────  Update Password  ──────────────── -->
    <form id="update-password-form" method="POST" action="/settings">
        <h3>Change Password</h3>
        <div class="mb-3">
            <label for="current_password" class="form-label">Current Password</label>
            <input type="password" class="form-control" id="current_password" name="current_password" required>
        </div>
        <div class="mb-3">
            <label for="new_password" class="form-label">New Password</label>
            <input type="password" class="form-control" id="new_password" name="new_password" required>
        </div>
        <div class="mb-3">
            <label for="confirm_new_password" class="form-label">Confirm New Password</label>
            <input type="password" class="form-control" id="confirm_new_password" name="confirm_new_password" required>
        </div>
        <ul class="validation-list mb-3 ps-4" id="settings-password-rules">
          <li id="settings-length" class="invalid"><span class="emoji">❌</span> At least 8 characters</li>
          <li id="settings-letter" class="invalid"><span class="emoji">❌</span> At least one letter (a-zA-Z)</li>
          <li id="settings-number" class="invalid"><span class="emoji">❌</span> At least one number (0-9)</li>
          <li id="settings-symbol" class="invalid"><span class="emoji">❌</span> At least one special character (!@#$%)</li>
          <li id="settings-match" class="invalid"><span class="emoji">❌</span> Both passwords must be the same</li>
        </ul>
        <button type="submit" class="btn btn-warning" name="action" value="update_password" id="settings-change-btn" disabled>Change Password</button>
    </form>

    <hr>

    <!-- ────────────────  Delete Account  ──────────────── -->
    <form id="delete-account-form" method="POST" action="/settings">
        <h3>Delete Account</h3>
        <p class="text-danger">Warning: This action cannot be undone.</p>
        <button type="submit" class="btn btn-danger" name="action" value="delete_account">Delete Account</button>
    </form>
</div>

<script src="{{ url_for('static', filename='JS/sign_up.js') }}"></script>
<script>
    // Attach enhanced fetch handling to all three forms
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', event => {
            event.preventDefault();
            // include the clicked button automatically
            const formData = new FormData(form, event.submitter);
            fetch('/settings', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showOzfoodyNotification(data.message, "success");
                    if (form.id === 'delete-account-form') {
                        // redirect to landing page after account deletion
                        window.location.href = '/landing';
                    }
                } else {
                    showOzfoodyNotification(data.error || 'An unexpected error occurred.', "error");
                }
            })
            .catch(err => console.error('Fetch error:', err));
        });
    });

    // For settings page
    OzfoodyPassword.setupPasswordValidation(
        'new_password', 'confirm_new_password', 'settings-change-btn',
        { length: 'settings-length', letter: 'settings-letter', number: 'settings-number', symbol: 'settings-symbol', match: 'settings-match' }
    );
    // Add password toggle if you add eye icons to settings page
    // OzfoodyPassword.setupPasswordToggle('new_password', 'toggle-new-password', 'eye-icon-new');
    // OzfoodyPassword.setupPasswordToggle('confirm_new_password', 'toggle-confirm-new-password', 'eye-icon-confirm-new');
</script>
{% endblock %}
