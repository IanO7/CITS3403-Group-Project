{% extends "base.html" %}
{% block title %}OZfoody - Inbox{% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/general_styles.css') }}"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/alert.css') }}">
<h2>
    Inbox
    {% if unseen_count and unseen_count > 0 %}
        <span class="badge bg-danger" style="font-size:1rem;vertical-align:top;">
            {{ unseen_count }}
        </span>
    {% endif %}
</h2>

<!-- Incoming follow requests -->
{% if incoming_requests %}
    <h4>Follow Requests</h4>
    <ul class="list-group mb-4">
    {% for req in incoming_requests %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>
                <strong>{{ req.follower.username }}</strong> wants to follow you.
            </span>
            <span>
                <button class="btn btn-primary btn-sm approve-follow-btn" data-id="{{ req.id }}">Approve</button>
                <button class="btn btn-danger btn-sm reject-follow-btn" data-id="{{ req.id }}">Reject</button>
            </span>
        </li>
    {% endfor %}
    </ul>
{% endif %}

{% if posts %}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
    {% for item in posts %}
        <div class="card-header">
            <strong>From: {{ item.sender.username }}</strong><br>
            <em>{{ item.timestamp.strftime('%Y-%m-%d %H:%M') }}</em>
            {% set review = item.note %}
            {% set current_user = user %}
            {% include "post.html" %}
        </div>
    {% endfor %}
    </div>
{% else %}
    <p>No shared posts yet.</p>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.approve-follow-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            fetch(`/approve_follow/${btn.dataset.id}`, {method: 'POST'})
                .then(res => res.json())
                .then(data => {
                    showOzfoodyNotification(data.message || "Request approved.", "success");
                    btn.closest('li').remove();
                });
        });
    });
    document.querySelectorAll('.reject-follow-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            fetch(`/reject_follow/${btn.dataset.id}`, {method: 'POST'})
                .then(res => res.json())
                .then(data => {
                    showOzfoodyNotification(data.message || "Request rejected.", "error");
                    btn.closest('li').remove();
                });
        });
    });
});
</script>
{% endblock %}