{% extends "base.html" %}
{% block title %}OZfoody - My Stats Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/general_styles.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/badge.css') }}">

<div class="dashboard-container">
    <!-- Welcome Section -->
    <div class="dashboard-header">
        <div class="profile-info">
            {% if user.profileImage %}
                <img src="{{ url_for('views.uploaded_file', filename=user.profileImage) }}" class="profileImage" alt="profile image"> 
            {% endif %} 
            <div>
                <h1>
                    Welcome back, <span class="user-name">{{ user.username }}</span>!
                </h1>
                <p>Your personalized food journey dashboard.</p>
            </div>
        </div>
    </div>

    <!-- Level Progress Section -->
    <div class="level-progress-card card stat-card mb-4">
        <div class="level-progress-header">
            <span class="level-label">Level {{ user_level }}</span>
            <span class="level-desc">
                {% set earned = badges|selectattr('earned')|list|length %}
                {% set next_level = user_level + 1 if user_level < 5 else 5 %}
                {% set needed = [1,2,4,6,6][user_level-1] %}
                {% if user_level < 5 %}
                    {{ earned }} / {{ needed }} achievements for Level {{ next_level }}
                {% else %}
                    All achievements unlocked!
                {% endif %}
            </span>
        </div>
        <div class="progress level-progress-bar">
            {% set needed = [1,2,4,6,6][user_level-1] %}
            <div class="progress-bar bg-warning animated-bar" style="width: {{ (earned / needed * 100) | default(0) }}%;" data-target="{{ (earned / needed * 100)  | default(0) }}"></div>
        </div>
    </div>

    <h1 class="text-center mb-4">Statistics for {{ user.username }}</h1>

    <!-- Statistics Section -->
    <div class="stats-grid">
        <!-- Taste Stats -->
        <div class="card stat-card">
            <h3 class="card-title">üå∂Ô∏è Spiciness</h3>
            <div class="progress custom-progress">
                <div class="progress-bar bg-danger animated-bar" style="width: {{ stats.spiciness | default(0) }}%;" data-target="{{ stats.spiciness | default(0) }}"></div>
            </div>
            <p>{{ stats.spiciness | default(0) | round(0) |int }}% spicy dishes rated</p>
        </div>

        <div class="card stat-card">
            <h3 class="card-title">ü§§ Deliciousness</h3>
            <div class="progress custom-progress">
                <div class="progress-bar bg-success animated-bar" style="width: {{ stats.deliciousness | default(0) }}%;" data-target="{{ stats.deliciousness | default(0) }}"></div>
            </div>
            <p>{{ stats.deliciousness | default(0) | round(0) |int }}% delicious dishes rated</p>
        </div>

        <div class="card stat-card">
            <h3 class="card-title">üí∞ Value</h3>
            <div class="progress custom-progress">
                <div class="progress-bar bg-warning animated-bar" style="width: {{ stats.value | default(0) }}%;" data-target="{{ stats.value | default(0) }}"></div>
            </div>
            <p>{{ stats.value | default(0) | round(0) |int }}% value-rated dishes</p>
        </div>

        <div class="card stat-card">
            <h3 class="card-title">üçΩÔ∏è Service</h3>
            <div class="progress custom-progress">
                <div class="progress-bar bg-info animated-bar" style="width: {{ stats.service | default(0) }}%;" data-target="{{ stats.service | default(0) }}"></div>
            </div>
            <p>{{ stats.service | default(0) | round(0) |int }}% service-rated dishes</p>
        </div>


    </div>

    <!-- Overall Average Rating -->
    <div class="card stat-card mt-4">
        <h3 class="card-title">‚≠ê Overall Average Rating</h3>
        <div class="progress custom-progress">
            <div class="progress-bar bg-primary animated-bar" style="width: {{ overall_average_rating | default(0) }}%;" data-target="{{ overall_average_rating | default(0) }}"></div>
        </div>
        <p>{{ overall_average_rating | default(0) | round(0) |int }}% average rating across all reviews</p>
    </div>

    
    <!-- Favorite Cuisine Card -->
    <div class="card stat-card mt-4" style="background: #fffbe6; border-color: #ffe066;">
        <h3 class="card-title">üçΩÔ∏è Favorite Cuisine</h3>
        <div style="font-size: 2rem; font-weight: bold; color: #b8860b; margin: 10px 0;">
            {{ favorite_cuisine or "No favorite cuisine yet" }}
        </div>
        <p class="text-muted">Based on your reviews</p>
    </div>

    <!-- Recommended Food -->
    <div class="card stat-card mt-4">
        <h3 class="card-title">Today, I will be eating...</h3>
        <div id="recommended-food" class="recommendation-box">
            <!-- First recommendation will be loaded here automatically -->
        </div>
        <button id="get-recommendation" class="btn btn-primary mt-3">Get More Recommendations</button>
    </div>

    <!-- Search Section -->
    <div class="card stat-card mt-4">
        <h3 class="card-title">üîç Search Reviews</h3>
        <div class="form-group">
            <input type="text" id="search-query" class="form-control" placeholder="Search food near me......or...spicy food">
        </div>
        <button id="search-button" class="btn btn-primary mt-3">Search</button>
        <div id="search-results" class="recommendation-box mt-3">
            <!-- Search results will be displayed here -->
        </div>
    </div>

    <!-- Badges Section -->
    <div class="badges-section mt-5">
        <h2 class="text-center">Your Achievements</h2>
        <div class="badges-container">
            {% for badge in badges %}
            <div class="badge-card {% if badge.earned %}earned{% else %}not-earned{% endif %}">
                <h3>{{ badge.name }}</h3>
                <p>{{ badge.description }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
    .recommendation-box {
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 10px;
        background-color: #f9f9f9;
    }

    .recommendation-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        background-color: #fff;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease-in-out;
    }

    .recommendation-card:hover {
        transform: scale(1.02);
    }

    .recommendation-card img {
        width: 100%;
        max-width: 300px;
        height: 200px;
        object-fit: cover;
        border-radius: 10px;
        margin-bottom: 10px;
    }

    .recommendation-card h5 {
        font-size: 1.2rem;
        margin-bottom: 5px;
    }

    .recommendation-card p {
        font-size: 0.9rem;
        color: #555;
    }

    .badges-container {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    .badge-card {
        width: 150px;
        height: 150px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        border: 2px solid #ddd;
        border-radius: 10px;
        background-color: #f9f9f9;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .badge-card h3 {
        font-size: 1.2rem;
        margin-bottom: 10px;
    }

    .badge-card p {
        font-size: 0.9rem;
        color: #555;
    }

    .badge-card.earned {
        border-color: #5F8D3B;
        background-color: #eaffea;
        box-shadow: 0 8px 15px rgba(95, 141, 59, 0.5);
        transform: scale(1.05);
    }

    .badge-card.not-earned {
        opacity: 0.5;
        background-color: #f0f0f0;
    }

    .badge-card:hover {
        transform: scale(1.1);
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const userProfileImageUrl = "{{ url_for('views.uploaded_file', filename=user.profileImage) if user.profileImage else url_for('static', filename='default_profile.png') }}";
    const uploadedFileUrl = "{{ url_for('views.uploaded_file', filename='') }}";

    document.addEventListener('DOMContentLoaded', () => {
        // Chart.js setup (if you have a canvas with id 'foodChart')
        if (document.getElementById('foodChart')) {
            const foodChartCtx = document.getElementById('foodChart').getContext('2d');
            new Chart(foodChartCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Spicy', 'Delicious', 'Value', 'Service'],
                    datasets: [{
                        data: [{{ stats.spiciness }}, {{ stats.deliciousness }}, {{ stats.value }}, {{ stats.service }}],
                        backgroundColor: ['#DF6F1B', '#5F8D3B', '#8E5F2B', '#6E3A14']
                    }]
                }
            });
        }

        // Recommendation logic
        let recommendationIndex = 0;
        let recommendations = [];
        const getRecommendationBtn = document.getElementById('get-recommendation');
        const recommendationBox = document.getElementById('recommended-food');

        function fetchRecommendations() {
            fetch(`/recommend_food`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        recommendations = data.recommendations;
                        recommendationIndex = 0;
                        if (recommendations.length > 0) {
                            recommendationBox.innerHTML = renderPostCard(recommendations[recommendationIndex], userProfileImageUrl, '{{ user.username }}');
                            getRecommendationBtn.disabled = false;
                            getRecommendationBtn.innerText = "Get More Recommendations";
                            recommendationIndex = 1;
                        } else {
                            recommendationBox.innerText = 'No recommendations found.';
                            getRecommendationBtn.disabled = true;
                            getRecommendationBtn.innerText = "No More Recommendations";
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function displayRecommendation(post) {
            recommendationBox.innerHTML = renderPostCard(post, userProfileImageUrl, '{{ user.username }}');
        }

        if (getRecommendationBtn) {
            getRecommendationBtn.addEventListener('click', () => {
                if (recommendationIndex < recommendations.length) {
                    displayRecommendation(recommendations[recommendationIndex]);
                    recommendationIndex++;
                    if (recommendationIndex >= recommendations.length) {
                        getRecommendationBtn.disabled = true;
                        getRecommendationBtn.innerText = "No More Recommendations";
                        recommendationBox.innerHTML += `<div class="text-muted mt-2">No more recommendations.</div>`;
                    }
                } else {
                    recommendationBox.innerHTML += `<div class="text-muted mt-2">No more recommendations.</div>`;
                    getRecommendationBtn.disabled = true;
                    getRecommendationBtn.innerText = "No More Recommendations";
                }
            });
            fetchRecommendations();
        }

        // Search logic
        const searchButton = document.getElementById('search-button');
        const searchQuery = document.getElementById('search-query');
        const searchResults = document.getElementById('search-results');

        if (searchButton && searchQuery && searchResults) {
            searchButton.addEventListener('click', function() {
                const query = searchQuery.value.trim().toLowerCase();
                if (query.includes('near me') && navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        fetch(`/api/search_reviews?q=near me&lat=${position.coords.latitude}&lng=${position.coords.longitude}`)
                            .then(response => response.json())
                            .then(data => {
                                searchResults.innerHTML = '';
                                if (data.success && data.results.length > 0) {
                                    data.results.forEach(post => {
                                        searchResults.innerHTML += renderPostCard(post, userProfileImageUrl, '{{ user.username }}');
                                    });
                                } else {
                                    searchResults.innerHTML = '<p class="text-muted">No results found for your search.</p>';
                                }
                            })
                            .catch(error => {
                                searchResults.innerHTML = '<p class="text-danger">No food recommendations üò¢</p>';
                            });
                    });
                } else {
                    fetch(`/api/search_reviews?q=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            searchResults.innerHTML = '';
                            if (data.success && data.results.length > 0) {
                                data.results.forEach(post => {
                                    searchResults.innerHTML += renderPostCard(post, userProfileImageUrl, '{{ user.username }}');
                                });
                            } else {
                                searchResults.innerHTML = '<p class="text-muted">No results found for your search.</p>';
                            }
                        })
                        .catch(error => {
                            searchResults.innerHTML = '<p class="text-danger">No food recommendations üò¢</p>';
                        });
                }
            });
        }
    });

    function renderPostCard(post, userProfileImage, username) {
        const profileImg = userProfileImageUrl;
        let postImg = '';
        if (post.image) {
            postImg = uploadedFileUrl.endsWith('/') ? uploadedFileUrl + post.image : uploadedFileUrl + '/' + post.image;
        }
        return `
        <div class="card mb-4 shadow-sm rounded-4 h-100" style="min-height: 500px;">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3 w-100">
                    <img src="${profileImg}" alt="Profile Avatar" class="profileImageSmall">
                    <h5 class="card-title mb-1" style="margin-left:10px;">${post.restaurant || post.Resturaunt || ''}</h5>
                    <div class="star-rating text-warning" style="margin-left:10px;">
                        ${(() => {
                            let stars = parseInt(post.stars || post.Stars || 0);
                            let html = '';
                            for (let i = 0; i < stars; i++) html += '<i class="fa fa-star text-warning"></i>';
                            for (let i = stars; i < 5; i++) html += '<i class="fa fa-star text-muted"></i>';
                            return html;
                        })()}
                    </div>
                </div>
                <div class="card-body d-flex flex-column p-3" style="overflow-y: auto; max-height: 150px;">
                    <p class="card-text mb-0">${post.review || post.Review || ''}</p>
                </div>
                <h5 class="card-text">${post.cuisine || post.Cuisine || ''}</h5>
                <p class="card-text"><strong>Location:</strong> ${post.location || "Not specified"}</p>
                ${post.image ? `<img src="${postImg}" class="post-image" alt="Dish Image">` : ''}
                <div class="row text-center">
                    <div class="col">
                        <h6>Deliciousness</h6>
                        <div class="progress">
                            <div class="progress-bar bg-warning"
                                role="progressbar"
                                style="width: ${(post.deliciousness || post.Deliciousness || 0)}%;"
                                aria-valuenow="${post.deliciousness || post.Deliciousness || 0}"
                                aria-valuemin="0"
                                aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="col">
                        <h6>Spiciness</h6>
                        <div class="progress">
                            <div class="progress-bar bg-danger"
                                role="progressbar"
                                style="width: ${(post.spiciness || post.Spiciness || 0)}%;"
                                aria-valuenow="${post.spiciness || post.Spiciness || 0}"
                                aria-valuemin="0"
                                aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="col">
                        <h6>Value</h6>
                        <div class="progress">
                            <div class="progress-bar bg-success"
                                role="progressbar"
                                style="width: ${(post.value || post.Value || 0)}%;"
                                aria-valuenow="${post.value || post.Value || 0}"
                                aria-valuemin="0"
                                aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="col">
                        <h6>Service</h6>
                        <div class="progress">
                            <div class="progress-bar bg-info"
                                role="progressbar"
                                style="width: ${(post.service || post.Service || 0)}%;"
                                aria-valuenow="${post.service || post.Service || 0}"
                                aria-valuemin="0"
                                aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        `;
    }
</script>
{% endblock %}
{% block scripts %}
    <script src="{{ url_for('static', filename='JS/stats.js') }}"></script>
{% endblock %}