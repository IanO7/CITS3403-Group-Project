{% block content %}
        <div class="col">
            
            <div class="card mb-4 shadow-sm rounded-4 h-100" style="min-height: 500px;">

                <input type="checkbox" class="multi-share-checkbox" id="checkbox" value="{{ review.id }}" style="position:absolute;top:10px;left:10px;z-index:2;display:none;">

                <div class="card-body">

                    <div class="d-flex align-items-center mb-3 w-100">
                        <img src="{{ url_for('views.uploaded_file', filename=user.profileImage) }}"
                            alt="Profile Avatar"
                            class="profileImageSmall"> 

                        <h5 class="card-title mb-1">{{ review.Resturaunt }}</h5>
        
                        <div class="star-rating text-warning">
                            {% set stars = review.Stars | int %}

                            {# Render filled stars #}
                            {% for _ in range(stars) %}
                            <i class="fa fa-star text-warning"></i>
                            {% endfor %}

                            {# Render empty stars #}
                            {% for _ in range(5 - stars) %}
                            <i class="fa fa-star text-muted"></i>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="card-body d-flex flex-column p-3" style="overflow-y: auto; max-height: 150px;">
                        <p class="card-text mb-0">{{ review.Review }}</p>
                    </div> 

                    <h5 class="card-text">{{ review.Cuisine }}</h5>

                    <p class="card-text"><strong>Location:</strong> {{ review.location or "Not specified"}}</p>
                    
                    {% if review.image %}
                    <img src="{{ url_for('views.uploaded_file', filename=review.image) }}"
                        class="post-image"
                        alt="Dish Image">
                    {% endif %}

                    <div class="row text-center">
                        <div class="col">
                            <h6>Deliciousness</h6>
                            <div class="progress">
                                <div class="progress-bar bg-warning"
                                        role="progressbar"
                                        style="width: {{ review.Deliciousness | default(0, true) }}%;"
                                        aria-valuenow="{{ review.Deliciousness }}"
                                        aria-valuemin="0"
                                        aria-valuemax="100"></div>
                            </div>
                        </div>
                        <div class="col">
                            <h6>Spiciness</h6>
                            <div class="progress" >
                                <div class="progress-bar bg-danger"
                                        role="progressbar"
                                        style="width: {{ review.Spiciness }}%;"
                                        aria-valuenow="{{ review.Spiciness }}"
                                        aria-valuemin="0"
                                        aria-valuemax="100"></div>
                            </div>
                        </div>
                        <div class="col">
                            <h6>Value</h6>
                            <div class="progress" >
                                <div class="progress-bar bg-success"
                                        role="progressbar"
                                        style="width: {{ review.Value }}%;"
                                        aria-valuenow="{{ review.Value }}"
                                        aria-valuemin="0"
                                        aria-valuemax="100"></div>
                            </div>
                        </div>
                        <div class="col">
                            <h6>Service</h6>
                            <div class="progress" >
                                <div class="progress-bar bg-info"
                                        role="progressbar"
                                        style="width: {{ review.Service }}%;"
                                        aria-valuenow="{{ review.Service }}"
                                        aria-valuemin="0"
                                        aria-valuemax="100"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="reaction-buttons">
                    <button class="btn btn-outline-primary like-button" data-note-id="{{ review.id }}">
                        <i class="bi bi-hand-thumbs-up"></i> üëç <span class="action-count">{{ review.likes }}</span>
                    </button>
                    <button class="btn btn-outline-secondary comment-button" data-bs-toggle="modal" data-bs-target="#commentsModal">
                        <i class="bi bi-chat"></i> üí¨
                    </button>
                    {% if show_actions is not defined or show_actions %}
                        <button class="btn btn-outline-success share-button" data-note-id="{{ review.id }}">
                            <i class="bi bi-share"></i> üîó
                        </button>
                        <button class="btn btn-outline-danger delete-button" data-note-id="{{ review.id }}">
                            <i class="bi bi-trash"></i> üóëÔ∏è
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    <div class="modal fade" id="commentsModal" tabindex="-1" aria-labelledby="commentsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
            
            <div class="modal-header">
                <h5 class="modal-title" id="commentsModalLabel">Comments</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body">
                <form method="POST">
                    <div class="form-group p-3">
                        <input type="hidden" name="note_id" value="{{ review.id }}">
                        <input type="hidden" name="parentID" value="0">
                        <textarea class="form-control w-100" id="Comment" name="Comment" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" id="Comment_button">Comment</button>
                </form>
            </div>
            
            <div id="comment-area" class="mb-4 p-3 border rounded bg-light shadow-sm"> </div>
        
        </div>
    </div>

    <script>
        const comments = {{ comments_by_review[review.id] | tojson }};

        function getComments() {
            const commentContainer = document.getElementById("comment-area");

            comments.forEach(comment => {
                // Create comment wrapper
                const commentWrapper = document.createElement("div");
                commentWrapper.setAttribute("id", `comment-${comment.id}`);
                commentWrapper.classList.add("p-3", "border", "rounded", "bg-light", "shadow-sm");
                
                commentWrapper.innerHTML = `
                    <div> 
                    <img src="${comment.profileImage}" alt="Profile Avatar" class="profileImageSmaller"> 
                    <strong> {{review.user.username}} </strong> 
                    </div> 
                    <p> ${comment.Comment}</p>
                    <button class="btn btn-sm btn-outline-primary reply-toggle" data-comment-id="${comment.id}" onClick='displayForm(${comment.id})'> reply </button> 
                    <div class="d-none" id="reply-form-${comment.id}"> 
                    <form method="POST">
                        <div class="form-group p-3">
                            <input type="hidden" name="note_id" value="{{review.id}}">
                            <input type="hidden" name="parentID" value="${comment.id}">
                            <input type="text-area" class="form-control" id="Comment" name="Comment" required>
                        </div>
                    <button type="submit" class="btn btn-primary" id="Comment_button">Reply</button>
                    </form>
                    </div> 
                `;

                if (comment.parentID === 0) {
                    commentContainer.appendChild(commentWrapper);
                } 
                else {
                    var parent = document.getElementById(`comment-${comment.parentID}`)
                    let commentDetails = parent.querySelector('details')

                    if (!commentDetails) {
                        // Create one only if it doesn't already exist
                        commentDetails = document.createElement("details");
                        commentDetails.classList.add("mt-3", "ms-4");

                        var commentSummary = document.createElement("summary");
                        commentSummary.textContent = "Replies";
                        commentDetails.appendChild(commentSummary);
                        parent.appendChild(commentDetails);
                    }
                    if (parent) {
                        commentWrapper.classList.add("mt-3", "ms-4");
                        parent.appendChild(commentDetails);
                        commentDetails.appendChild(commentWrapper);
                    } else {
                        commentContainer.appendChild(commentWrapper); // fallback
                    }
                }
            });

            document.querySelectorAll('.reply-toggle').forEach(button => {
                button.addEventListener('click', () => {
                    const commentId = button.dataset.commentId;
                    const form = document.getElementById(`reply-form-${commentId}`);
                    if (form) {
                        form.classList.toggle('d-none');
                    }
                });
            });
        }


        /*function displayForm(id) {
            var form = document.getElementById(`reply-form-${id}`);
            form.classList.toggle('d-none');

        }*/ 


        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.comment-button').forEach(button => {
                button.addEventListener('click', () => {
                    getComments()
                    const commentId = button.dataset.commentId;
                    const replyForm = document.getElementById(`reply-form-${commentId}`);
                });
            });
        }); 

        /*document.querySelectorAll('.comment-form').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);

                const response = await fetch('/api/comments', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const comments = await response.json();
                    console.log(comments); // Use this to re-render the comment section dynamically
                } else {
                    alert('Error submitting comment.');
                }
            });
        });*/ 


    </script>
          
{% endblock %}